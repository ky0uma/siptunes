## 📞 Interactive Character Call System
This project simulates phone calls to favorite animated characters using a SIP-based Python system. Designed for use in Docker, it leverages pjsua2 to manage VoIP calls, stream audio, and handle dynamic themes. Ideal for creating engaging experiences for children, the system allows interaction with different character "personalities."

---

### 🎯 Project Overview
#### Core Components:
* **switchboard.py**: Manages the SIP setup, handles incoming calls, and coordinates DTMF-based character interactions.

* **call.py**: Defines the SIP account class, managing user registration and authentication.

* **audio.py**: Handles audio streaming using FFMPEG, including playback of character responses based on DTMF input.

---

### Key Features:
- SIP Integration: Handles VoIP calls with customizable SIP configurations.
- DTMF Support: Maps DTMF inputs to specific audio responses.
- Theme Switching: Load and manage multiple character themes dynamically using the '*' and '#' keys.
- Playback: Playback from local of remote audio streams

---

### 📂 File Structure
```plaintext
workspace/                   
├── app/                             # Application source code
│   ├── switchboard.py               # Main logic for handling SIP calls and events
│   ├── call.py                      # Manages SIP accounts and call-related operations
│   ├── audio.py                     # Manages audio streams, playback, and recording
│   ├── const.py                     # Configuration constants (SIP details, paths, etc.)
│   ├── __main__.py                  # Entry point when running the module directly (python -m app)
│   ├── __init__.py                  # Initializes the 'app' package for imports
│   └── requirements.txt             # Lists Python dependencies for the project
│
├── sound/                           # Contains theme-based audio files and DTMF maps (mapped as a volume in Docker)
│   ├── <theme_1>/                   # Directory for Theme 1 audio files
│   │   ├── <response_1>.mp3         # Audio response file 1 for Theme 1
│   │   ├── <response_2>.mp3         # Audio response file 2 for Theme 1
│   │   └── <greeting>.mp3           # Greeting audio file for Theme 1
│   ├── <theme_2>/                   # Directory for Theme 2 audio files
│   │   ├── <response_1>.mp3         # Audio response file 1 for Theme 2
│   │   ├── <response_2>.mp3         # Audio response file 2 for Theme 2
│   │   └── <greeting>.mp3           # Greeting audio file for Theme 2
│   ├── dtmf_map_<theme_1>.json      # DTMF-to-audio mappings for Theme 1
│   └── dtmf_map_<theme_2>.json      # DTMF-to-audio mappings for Theme 2
│
├── docker/                          # Docker-related files
│   ├── Dockerfile                   # Defines the Docker image build process
│   └── user.mak                     # Input for compiling pjsua2
│
├── logs/                            # Stores runtime logs (mapped as a volume in Docker)
│   ├── app.err.log                  # Log file generated by the supervisord (example)
│   ├── app.out.log                  # Log file generated by the supervisord (example)
│   └── pjsua.log                    # Log file generated by the SIP library (example)
│
└── .env                             # Environment variables for configuration (mapped in Docker)
```

---

### ⚙️ Dependencies
#### System Requirements:
* Docker (Recommended for deployment)

---

### 🚀 Running the Project
#### 1. Clone the Repository:
```bash
git clone https://github.com/ky0uma/siptunes.git
cd siptunes
```

#### 2. Build with Docker:
Build the Docker Image:
```bash
docker build -t local/siptunes -f docker/Dockerfile .
```

#### 3. Prepare Audio Themes:
Place your audio files and DTMF mapping JSON files in the sound/ directory.

For each theme, you need to create a folder containing the corresponding audio files (e.g., responses and greetings). Also, ensure that the DTMF mapping JSON files follow this format:

```json
{
  "1": "response_1.mp3",
  "2": "response_2.mp3",
  "default": "greeting.mp3"
}
```

If you are using remote streams, there is no need to create theme folders for audio files. You will still need the DTMF mapping file, but the folder structure will be simplified. The DTMF mapping file should be placed directly inside the sound/ directory without any theme folder.

#### Directory Structure:
```plaintext
── sound/                           # Contains theme-based audio files and DTMF maps (mapped as a volume in Docker)
   ├── <theme_1>/                   # Directory for Theme 1 audio files
   │   ├── response_1.mp3           # Audio response 1 for Theme 1
   │   ├── response_2.mp3           # Audio response 2 for Theme 1
   │   └── greeting.mp3             # Greeting audio for Theme 1
   ├── <theme_2>/                   # Directory for Theme 2 audio files
   │   ├── response_1.mp3           # Audio response 1 for Theme 2
   │   ├── response_2.mp3           # Audio response 2 for Theme 2
   │   └── greeting.mp3             # Greeting audio for Theme 2
   ├── dtmf_map_<theme_1>.json      # DTMF-to-audio mapping for Theme 1
   └── dtmf_map_<theme_2>.json      # DTMF-to-audio mapping for Theme 2
```
If using remote streams (e.g., RTSP, HTTP, etc.), the structure simplifies:

```plaintext

── sound/                           # Contains DTMF maps and possibly remote stream references (no theme folders)
   ├── dtmf_map_<theme_1>.json      # DTMF-to-audio mapping for Theme 1 (no theme folder needed)
   ├── dtmf_map_<theme_2>.json      # DTMF-to-audio mapping for Theme 2
```

#### 4. Environment Variables
Customize the SIP settings and other configurations by modifying the .env file or passing environment variables when running Docker. Below is an example .env file with placeholders for customization:

Example .env file:
```plaintext
# Audio codec settings - change only if needed
CODEC=opus                      # Audio codec to use for SIP calls (e.g., opus, pcma, pcmu)
SAMPLERATE=48000                # Sample rate for audio (in Hz)

# SIP account settings - update with your specific values
SIP_DOMAIN=<sip_domain>             # The SIP domain for registration (e.g., example.com)
SIP_USERNAME=<sip_username>         # Your SIP account username
SIP_PASSWORD=<sip_password>         # Your SIP account password
SIP_OUTBOUND=<sip_outbound_ip>      # The IP address or host of the outbound SIP server

# Audio theme settings - choose the themes you want to use
THEMES=<theme_1>,<theme_2>          # A comma-separated list of theme directories to use for audio files
```

#### Description of Variables:
* **CODEC**: The audio codec to be used for SIP calls. Common options are opus, pcma, or pcmu.
* **SAMPLERATE**: The sample rate for the audio stream, typically 48000 Hz.
* **SIP_DOMAIN**: The SIP server's domain or hostname (e.g., sip.example.com).
* **SIP_USERNAME**: Your SIP account username.
* **SIP_PASSWORD**: The password for your SIP account.
* **SIP_OUTBOUND**: The IP address or hostname of the outbound SIP server, typically used for routing SIP calls.
* **THEMES**: A comma-separated list of theme directories that will be used for audio files. For example, theme_1,theme_2.

#### 4. Run the Docker Container:
```bash
docker run -d --rm --name "siptunes" \
  -v $(pwd)/.env:/workspace/.env \
  -v $(pwd)/sound:/workspace/sound \
  -v $(pwd)/logs:/workspace/logs \
  -p 5060:5060 \
  local/siptunes:latest
```
---

### 📝 Logging:
Logs are stored in the LOGS_DIR (logs) directory, as configured in const.py.

---

### 🧪 Testing
This software has been tested with UniFi Talk version 1.18.2. SSH access is required to configure the Talk application. 

#### Steps Taken for Testing:
**Retrieve User Password:** To access the user password for the SIP configuration, run the following command:

```bash
fs_cli -x "user_data 0005@talk.com param password"
```
This retrieves the password for the user 0005@talk.com to be used in the SIP settings.

**Modify Codec Preferences:** The default codec preferences need to be modified to support the OPUS codec. This requires editing the '/usr/share/unifi-talk/app/server.js' file on the UniFi Talk server.
Modify all instances of the following line:

```json
"codec-prefs",value:"PCMU,PCMA,G711"
```
to:

```json
"codec-prefs",value:"PCMU,PCMA,G711,OPUS"
``` 

**Restart UniFi Talk:** After modifying the codec preferences, restart the UniFi Talk service to apply the changes:

```bash
systemctl restart unifi-talk
```
Please note that these steps are specific to the version of UniFi Talk mentioned and may need to be adjusted for different versions / SIP instances.

---

### 📜 License
This project is licensed under the MIT License. See the LICENSE file for details.